version: "3.9"

networks:
  web:
    external: true
{% if service_config is defined %}
configs:
  {{ service_config_name }}:
    external: true
{% endif %}

services:
  {{ name }}:
    image: {{ image }}
    networks: [web]
{% if service_config is defined %}
    configs:
      - source: {{ service_config_name }}
        target: /{{ name }}.config.{{ service_config_format | default('yaml') }}
{% endif %}
{% if command is defined %}
    command: /bin/sh -c "exec {{ command }}{% if service_config is defined %} --config /{{ name }}.config.{{ service_config_format | default('yaml') }}{% endif %}"
{% endif %}
    deploy:
      replicas: {{ replicas | default(1) }}
      restart_policy: { condition: any }
      update_config: { order: start-first, parallelism: 1 }
      resources:
        reservations:
          cpus: '{{ cpu | default("0.25") }}'
          memory: '{{ memory | default("64M") }}'
      labels:
        - traefik.enable=true
        - traefik.docker.lbswarm=true
        - traefik.docker.network=web
        - traefik.http.services.{{ name }}.loadbalancer.server.port={{ port }}
